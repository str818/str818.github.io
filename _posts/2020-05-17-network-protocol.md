---
layout: article
title: 计算机网络 — 协议
tags: 计算机网络

lang: zh-Hans
key: Network_Protocol
pageview: true
toc: true
show_subscribe: false
---

## 为什么要学习网络协议？

只有通过网络协议，才能使一大片机器互相协作、共同完成一件事。

网络协议满足 **语法、语义、顺序** 三要素，以下面的 HTTP 协议为例：

```
HTTP/1.1 200 OK
Date: Tue, 27 Mar 2018 16:50:26 GMT Content-Type: text/html;charset=UTF-8 Content-Language: zh-CN
<!DOCTYPE html>
<html>
<head>
<base href="https://pages.kaola.com/" />
<meta charset="utf-8"/> <title> 网易考拉 3 周年主会场 </title>
```

- 符合语法，只有按照指定的格式，浏览器才认，先是状态、然后是首部、最后是内容。
- 符合语义，按照约定的意思来。例如，状态 200 表示网页返回成功。
- 符合顺序，先发出一个 HTTP 请求，才有上面的一段 HTTP 返回的数据。

## 浏览器输入 URL 回车后发生了什么？

1. **DNS 解析**

将域名解析成对应的服务器 IP 地址，客户端收到域名地址后，首先去找本地的 hosts 文件，检查在该文件中是否有相应的域名、IP 对应关系，如果有，则向其 IP 地址发送请求，如果没有，再去找 DNS 服务器。

DNS、HTTP 都在 **应用层**。

2. **建立 TCP 连接**

通过三次握手，建立客户端与服务器的 TCP 网络连接。

UDP、TCP 都在 **传输层**，传输层封装完毕后，会将包交给 **网络层**，网络层的协议是 IP 协议。

3. **发送 HTTP 请求**
4. **服务器处理请求**
5. **返回响应结果**
6. **关闭 TCP 连接**

通过四次挥手，断开客户端与服务器的 TCP 网络连接。

7. **浏览器解析 HTML**
8. **浏览器布局渲染**  

## 网络为什么要分层？

复杂的程序都要分层，每一层专注做本层的事情。

只要是在网络上跑的包，都是完整的。可以有下层没上层，绝对不可能有上层没有下层。

## 无类型域间路由（CIDR）

由于 C 类地址能包含的最大主机数量太少了，只有 254 个，而 B 类地址能包含的最大足迹数量又太多了，有 65534 个，为了解决这一尴尬的问题，就诞生了 CIDR，这种方式打破了原来设计的几类地址的做法，而是将 32 位的 IP 地址一分为二，前面是 **网络号**，后面是 **主机号**，例如 `10.100.122.2/24`，前 24 位表示网络号，后 8 位表示主机号。网络位全取 1 为**子网掩码**，例如 `255.255.255.0`，子网掩码与 IP 地址按位与运算可以得到网络号。

## MAC 地址

MAC 地址是全局唯一的，网卡生产数来的时候就已经有了，不会有两张网卡的 MAC 地址是相同的。

#### 为什么不用 MAC 地址进行通信呢？

MAC 地址更像是身份证号，是唯一的标识，比如你不能说我要找身份证号是 xxx 的人在哪，只能说是我要去北京市海淀徐xx小区xx门找到身份证号是 xxx 的人，MAC 地址的通信范围只局限在一个子网中。

## 动态主机配置协议（DHCP）

如果想要和其他机器通讯，就需要一个通讯地址，那么如果配置这个 IP 地址呢？这就用到 DHCP 协议了，它是一个局域网的网络协议，指的是由服务器控制一段 IP 地址范围，客户机登录服务器时就可以自动获得服务器分配的IP地址和子网掩码。

## 地址解析协议（ARP）

在网络通信中，主机和主机通信的数据包需要依据 OSI 模型从上到下进行数据封装，当数据封装完整后，再向外发出。所以在局域网的通信中，不仅需要源/目 IP 地址的封装，也需要源/目 MAC 地址的封装，上层应用程序更多关心 IP 地址，而不去管 MAC 地址，这时就需要 ARP 协议去找到 IP 地址和 MAC 地址的映射，即询问 IP 对应的 MAC 地址，询问方式靠「吼」。

## 生成树协议（STP）

在一个负载的网络环境中，难免会出现环路，环路会产生广播风暴，最终导致整个网络资源被耗尽，网络瘫痪不可用。为了破除环路，可以采用数据链路层协议 STP，运行该协议的设备通过彼此交互信息发现网络中的环路，并有选择的对某个端口进行阻塞，最终将环形网络结果修剪成无环路的树形网状结构。

## 虚拟局域网（VLAN）

一组逻辑上的设备和用户，不受物理位置的限制，可以根据功能、部门及应用等因素将他们组织起来，相互之间的通信就好像它们在同一个网段中一样，可以控制广播活动，提高网路的安全性。

## 互联网控制报文协议（ICMP）

网络包在异常复杂的网络环境中传输时，常常会遇到各种各样的问题。当遇到问题时，总不能死的不明不白，要传出消息来，报告情况，这样才可以调整传输策略。而 ICMP 就是用来确认 IP 包是否成功到达目的地址并通知在发送过程中 IP 包被丢弃的原因的，是一种网络层协议。

## 网关（Gateway）

网关是一个网络连接到另一个网络的「关口」，实质上是一个通过通向其他网络的 IP 地址。很多情况下，人们把网关就叫做路由器。其实不完全准确，路由器是一台设备，它有五个网口或者网卡，相当于有五只手，分别连着五个局域网。每只手的 IP 地址都和局域网的 IP 地址有相同的网段，每只手都是它握住的那个局域网的网关。

## 动态路由协议

### 1. OSPF

- 内部路由协议，向本自治系统中所有路由器发送信息
- 发送的信息就是与路由器相邻的所有路由器的链路状态，但这只是路由器所知道的部分信息
- 只有在链路状态发生变化时，路由器才向所有路由器用洪泛法发送此信息

### 2. RIP

- 内部路由协议，仅和相邻路由交换信息
- 路由器交换的信息是当前本路由器所知道的全部信息
- 按固定时间间隔交换路由信息，例如每隔 30 秒

### 3. BGP

外部路由协议，在一个国家内部，有路当前选近的走，但是国家质检，不光有远近的问题，还有政策的问题，这就好比从我家里到目的地最近，但是不是谁都能从我家走啊。

## TCP 和 UDP

[计算机网络 — 传输层 TCP 与 UDP 详解](https://str818.github.io/2019/07/18/network-transport_layer.html)

## 套接字 Socket

Socket 是在应用层和传输层之间的一个抽象层，它把 TCP/IP 层复杂的操作抽象为几个简单的接口供应用层调用，来实现进行在网络中的通信。Socket 的出现只是为了更方便的使用 TCP/IP 协议栈，形成了几个最基本的函数接口，例如 `carete`、`listen`、`accept`、`connect`、`read`、`write` 等。